use evmole;
use hex;

pub fn main() {
    // vulnerable contract
    //let code = hex::decode("60806040526004361015610011575f80fd5b5f803560e01c806313af40351461118257806323e30c8b14610555578063887d3797146103cb5780639425dd93146102ce578063c5ecf5ea146101905763fa461e331461005c575f80fd5b3461018d57606036600319011261018d57600435816024356044356001600160401b03811161017c576100939036906004016111e4565b83859295138015610184575b1561018057846040918101031261017c576100b9846113f1565b60209490926001600160a01b0391860135918216918290036101785785931561014d575060405163a9059cbb60e01b815233600482015260248101929092529092839190829081604481015b03925af180156101425761011857505080f35b8161013792903d1061013b575b61012f8183611338565b8101906113d9565b5080f35b503d610125565b6040513d85823e3d90fd5b60405163a9059cbb60e01b815233600482015260248101919091529384925082908160448101610105565b8480fd5b8280fd5b8380fd5b5083831361009f565b80fd5b503461018d57604036600319011261018d576001600160401b0360043581811161017c576101c2903690600401611211565b60249291929081358381116102ca576101df903690600401611211565b916101f460018060a01b038854163314611241565b865b818110610201578780f35b61021461020f82848a611288565b6112ac565b848210156102b757888260051b850135601e19863603018112156102b35785019182359089821161017c57602080940191803603831361018057839261025b913691611374565b90828583519301915af161026d6113aa565b5015610282575061027d9061127a565b6101f6565b606490600b876040519262461bcd60e51b845260048401528201526a10d85b1b0819985a5b195960aa1b6044820152fd5b5080fd5b634e487b7160e01b895260326004528589fd5b8580fd5b503461018d57602036600319011261018d576004356001600160401b0381116102b357602061030360a49236906004016111e4565b92839161031a60018060a01b038754163314611241565b604051632e7ff4ef60e11b8152306004820152736b175474e89094c44da98b954eedeac495271d0f60248201526a52b7d2dcc80cd2e4000000604482015260806064820152608481018490529485938492848401378181018301879052601f01601f19168101030181857360744434d6339a6b27d73d9eda62b6f66a0a04fa5af180156103c0576103a9575080f35b6101379060203d811161013b5761012f8183611338565b6040513d84823e3d90fd5b503461018d57606036600319011261018d576001600160401b0360043581811161017c576103fd903690600401611211565b91602480358281116102ca57610417903690600401611211565b939094604493843590811161055157610434903690600401611211565b91909561044b60018060a01b038a54163314611241565b885b898382106104585780f35b808087898c946104c58f61048e898d61048861020f8f8f9061048261020f8780946104d39b611288565b9b611288565b9a611288565b6040805163095ea7b360e01b60208083019182526001600160a01b03909c169782019788529235878c015291959193849290910190565b03601f198101835282611338565b51925af16104df6113aa565b81610521575b50156104fa57506104f59061127a565b61044d565b60649061534160f01b8960028a6040519462461bcd60e51b86526004860152840152820152fd5b80518015925083908315610539575b5050505f6104e5565b61054993508201810191016113d9565b5f8281610530565b8780fd5b503461018d5760a036600319011261018d5761056f6111ce565b6024356001600160a01b038116036102b3576001600160401b0390608435828111610180576105a29036906004016111e4565b9290917360744434d6339a6b27d73d9eda62b6f66a0a04fa330361113d57306001600160a01b03909116036110e85783928201916060818403126109c2576105e9816113f1565b9260208201358381116102ca57816106029184016113fe565b9260408301359081116102ca5761061992016113fe565b91156109f15760a0818051810103126108f75760405190610639826112c0565b6020810151825261064c6040820161141c565b90602083019182526106606060820161141c565b604084015260a060808201519160608501928352015191608084019283525f805160206119eb8339815191523b156102ca5760405163617ba03760e01b81528681806106af3060048301611430565b0381835f805160206119eb8339815191525af19081156109e65787916109d2575b50505190516001600160a01b03909116905f805160206119eb8339815191523b156102ca576040519163a415bcad60e01b83526004830152602482015260026044820152846064820152306084820152848160a481835f805160206119eb8339815191525af19081156109c75785916109ae575b505061075360249383516114c5565b60408281015190516370a0823160e01b81523060048201529360209185919082906001600160a01b03165afa92831561096c578493610977575b5073c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2908160018060a01b03604085015116036108fb575b5050604001516001600160a01b0316905f805160206119eb8339815191523b156108f7576040519163617ba03760e01b8352600483015260248201523060448201525f60648201528181608481835f805160206119eb8339815191525af180156103c0576108e3575b5050604051631a4ca37b60e21b8152736b175474e89094c44da98b954eedeac495271d0f60048201525f19602482015230604482015290602082606481845f805160206119eb8339815191525af19081156108d757506108a8575b505b60206040517f439148f0bbc682ca079e46d6e2c2f0c1e3b820f1a291b069d8882abf8cf18dd98152f35b602090813d83116108d0575b6108be8183611338565b810103126108cc575f61087c565b5f80fd5b503d6108b4565b604051903d90823e3d90fd5b6108ec906112ef565b61018d57805f610821565b5050fd5b515f805160206119eb8339815191523b15610178576040519163617ba03760e01b8352600483015260248201523060448201525f60648201528381608481835f805160206119eb8339815191525af190811561096c578491156107b857610961906112ef565b6108f757825f6107b8565b6040513d86823e3d90fd5b935091506020833d6020116109a6575b8161099460209383611338565b810103126108cc57839251915f61078d565b3d9150610987565b6109b7906112ef565b6109c257835f610744565b505050fd5b6040513d87823e3d90fd5b6109db906112ef565b6102ca57855f6106d0565b6040513d89823e3d90fd5b915060a08280518101031261017c5760405190610a0d826112c0565b60208301518252610a206040840161141c565b6020830152610a316060840161141c565b6040830152610a4e60a0608085015194606085019586520161141c565b60808301525f805160206119eb8339815191523b156101805760405163617ba03760e01b8152848180610a843060048301611430565b0381835f805160206119eb8339815191525af180156109c7576110d5575b506040828101519051631a4ca37b60e21b81526001600160a01b0390911660048201525f196024820152306044820152602081606481885f805160206119eb8339815191525af180156109c7576110aa575b5060408201516001600160a01b031673c02aaa39b223fe8d0a0e5c4f27ead9083c756cc11901611023575b610b2a9082516114c5565b60208181015160405163573ade8160e01b81526001600160a01b0390911660048201525f196024820152600260448201523060648201529081608481875f805160206119eb8339815191525af1801561096c57610ff8575b50604051631a4ca37b60e21b8152736b175474e89094c44da98b954eedeac495271d0f60048201526a52b7d2dcc80cd2e40000006024820152306044820152602081606481875f805160206119eb8339815191525af1801561096c57610fcd575b5060208101516001600160a01b03169173c02aaa39b223fe8d0a0e5c4f27ead9083c756cc1198301610c19575b5050505061087e565b516080909101516040516370a0823160e01b81523060048201526001600160a01b0391909116929091602083602481855afa9283156109c7578593610f99575b5080610ed05750604051630240bc6b60e21b815291606083600481875afa9283156109c75785908694610e78575b506001600160701b03938416931673c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2831015610e725792915b8115610e19578315801580610e10575b15610dba576103e590818402918483048103610da65785850202948286041482151715610d92576103e8808702968704141715610d7e578401809411610d6a578315610d5657610d4d955060405194610d1c866112c0565b8552602085015273c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2604085015260608401520460808201526117d4565b5f808080610c10565b634e487b7160e01b86526012600452602486fd5b634e487b7160e01b86526011600452602486fd5b634e487b7160e01b87526011600452602487fd5b634e487b7160e01b5f52601160045260245ffd5b634e487b7160e01b89526011600452602489fd5b60405162461bcd60e51b815260206004820152602860248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4c604482015267495155494449545960c01b6064820152608490fd5b50831515610cc4565b60405162461bcd60e51b815260206004820152602b60248201527f556e697377617056324c6962726172793a20494e53554646494349454e545f4960448201526a1394155517d05353d5539560aa1b6064820152608490fd5b91610cb4565b9350506060833d606011610ec8575b81610e9460609383611338565b8101031261017857610ea5836117c0565b6040610eb3602086016117c0565b94015163ffffffff8116036102ca575f610c87565b3d9150610e87565b90935060018103610f1d5750610f189260405192610eed84611302565b8352602083015273c02aaa39b223fe8d0a0e5c4f27ead9083c756cc260408301526060820152611900565b610d4d565b600203610f6057610f189260405192610f3584611302565b8352602083015273c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2604083015260608201526115cd565b60405162461bcd60e51b8152602060048201526011602482015270155b9cdd5c1c1bdc9d19590819195e1259607a1b6044820152606490fd5b9092506020813d602011610fc5575b81610fb560209383611338565b810103126108cc5751915f610c59565b3d9150610fa8565b602090813d8311610ff1575b610fe38183611338565b810103126108cc575f610be3565b503d610fd9565b602090813d831161101c575b61100e8183611338565b810103126108cc575f610b82565b503d611004565b604051631a4ca37b60e21b815273c02aaa39b223fe8d0a0e5c4f27ead9083c756cc260048201525f196024820152306044820152602081606481885f805160206119eb8339815191525af180156109c75761107f575b50610b1f565b602090813d83116110a3575b6110958183611338565b810103126108cc575f611079565b503d61108b565b602090813d83116110ce575b6110c08183611338565b810103126108cc575f610af4565b503d6110b6565b6110e1909491946112ef565b925f610aa2565b60405162461bcd60e51b815260206004820152602760248201527f466c617368426f72726f7765723a20556e74727573746564206c6f616e20696e60448201526634ba34b0ba37b960c91b6064820152608490fd5b60405162461bcd60e51b815260206004820152601f60248201527f466c617368426f72726f7765723a20556e74727573746564206c656e646572006044820152606490fd5b503461018d57602036600319011261018d5761119c6111ce565b8154906001600160a01b03906111b53383851614611241565b16906bffffffffffffffffffffffff60a01b1617815580f35b600435906001600160a01b03821682036108cc57565b9181601f840112156108cc578235916001600160401b0383116108cc57602083818601950101116108cc57565b9181601f840112156108cc578235916001600160401b0383116108cc576020808501948460051b0101116108cc57565b1561124857565b60405162461bcd60e51b815260206004820152600a60248201526927b7363c9037bbb732b960b11b6044820152606490fd5b5f198114610d925760010190565b91908110156112985760051b0190565b634e487b7160e01b5f52603260045260245ffd5b356001600160a01b03811681036108cc5790565b60a081019081106001600160401b038211176112db57604052565b634e487b7160e01b5f52604160045260245ffd5b6001600160401b0381116112db57604052565b608081019081106001600160401b038211176112db57604052565b602081019081106001600160401b038211176112db57604052565b90601f801991011681019081106001600160401b038211176112db57604052565b6001600160401b0381116112db57601f01601f191660200190565b92919261138082611359565b9161138e6040519384611338565b8294818452818301116108cc578281602093845f960137010152565b3d156113d4573d906113bb82611359565b916113c96040519384611338565b82523d5f602084013e565b606090565b908160209103126108cc575180151581036108cc5790565b359081151582036108cc57565b9080601f830112156108cc5781602061141993359101611374565b90565b51906001600160a01b03821682036108cc57565b736b175474e89094c44da98b954eedeac495271d0f81526a52b7d2dcc80cd2e400000060208201526001600160a01b0390911660408201525f606082015260800190565b91908260809103126108cc5760405161148c81611302565b606080829461149a8161141c565b84526114a86020820161141c565b60208501526114b96040820161141c565b60408501520151910152565b80611533575060a0818051810103126108cc576115319060a0604051916114eb836112c0565b6114f76020820161141c565b83526115056040820161141c565b60208401526115166060820161141c565b604084015260808101516060840152015160808201526117d4565b565b600181036115625750805181016080828203126108cc576115319160208061155d93019101611474565b611900565b600203610f6057805181016080828203126108cc576115319160208061158a93019101611474565b6115cd565b91908251928382525f5b8481106115b9575050825f602080949584010152601f8019910116010190565b602081830181015184830182015201611599565b80516040805163038fff2d60e41b815260209390926001600160a01b03919085908590600490829086165afa9384156117b6575f94611787575b508185820151166060838584015116920151918451936116268561131d565b5f855285519060c08201978289106001600160401b038a11176112db57600498885282528882015f8152878301948552606083019384526080830195865260a0830196875287519361167785611302565b3085528a8501905f82528986019230845260608701955f875260e08c519d8e6352bbbe29831b815201525160e48d0152516002811015611773578c998c99868094818d9c6116f0966101048f015251166101248d015251166101448b0152516101648a01525160c06101848a01526101a489019061158f565b955116602487015251151560448601525116606484015251151560848301525f60a48301525f1960c483015203815f73ba12222222228d8ba445958a75a0704d566bf2c85af190811561176a5750611746575050565b813d8311611763575b6117598183611338565b810103126108cc57565b503d61174f565b513d5f823e3d90fd5b634e487b7160e01b5f52602160045260245ffd5b90938582813d83116117af575b61179e8183611338565b8101031261018d575051925f611607565b503d611794565b83513d5f823e3d90fd5b51906001600160701b03821682036108cc57565b80516020808301805160608501516040805163a9059cbb60e01b81526001600160a01b03968716600482018190526024820193909352928616979690959194909391929081806044810103815f809c5af180156118f6579183929160809594926118d8575b505116908583015116115f146118cf5701519084915b83519261185b8461131d565b868452823b156118cb5791869391846118a497989487519889958694859363022c0d9f60e01b85526004850152602484015230604484015260806064840152608483019061158f565b03925af19182156118c15750506118b85750565b611531906112ef565b51903d90823e3d90fd5b8680fd5b0151908461184f565b6118ef9060203d811161013b5761012f8183611338565b505f611839565b86513d8a823e3d90fd5b8051602082015160408084015190936001600160a01b0392831693918316841091831682156119cf576401000276ad935b8651958460208801528787015286865260608601948686106001600160401b038711176112db57879460608795868852015190630251596160e31b86523060648a0152608489015260a48801521660c486015260a060e4860152815f605f198761199f61010482018261158f565b0301925af180156117b6576119b357505050565b82903d84116119c7575b8161175991611338565b3d91506119bd565b73fffd8963efd1fc6a506488495d951d5263988d259361193156fe00000000000000000000000087870bca3f3fd6335c3f4ce8392d69350b4fa4e2a2646970667358221220cf4f7321130d39a21cd1461f527aeb5ecd6a277c6c2797246e7af3409306af9c64736f6c63430008140033").unwrap();

    // attack contract 
    let code = hex::decode("608060405234801561001057600080fd5b50600436106100365760003560e01c806333f3d6281461003b578063978f3f3614610057575b600080fd5b610055600480360381019061005091906105a0565b610073565b005b610071600480360381019061006c91906105e0565b6101a4565b005b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610101576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016100f89061067d565b60405180910390fd5b8173ffffffffffffffffffffffffffffffffffffffff1663a9059cbb60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b815260040161015c9291906106bb565b6020604051808303816000875af115801561017b573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061019f919061071c565b505050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614610232576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102299061067d565b60405180910390fd5b81600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506102bc6102c0565b5050565b600060018060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff166040516020016102f7929190610758565b6040516020818303038152906040529050600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663fa461e3368017b8b2a994a28800080846040518463ffffffff1660e01b815260040161037093929190610869565b600060405180830381600087803b15801561038a57600080fd5b505af115801561039e573d6000803e3d6000fd5b505050506000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016103ff91906108a7565b602060405180830381865afa15801561041c573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061044091906108d7565b9050600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a9059cbb60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff16836040518363ffffffff1660e01b81526004016104bf9291906106bb565b6020604051808303816000875af11580156104de573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610502919061071c565b505050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006105378261050c565b9050919050565b6105478161052c565b811461055257600080fd5b50565b6000813590506105648161053e565b92915050565b6000819050919050565b61057d8161056a565b811461058857600080fd5b50565b60008135905061059a81610574565b92915050565b600080604083850312156105b7576105b6610507565b5b60006105c585828601610555565b92505060206105d68582860161058b565b9150509250929050565b600080604083850312156105f7576105f6610507565b5b600061060585828601610555565b925050602061061685828601610555565b9150509250929050565b600082825260208201905092915050565b7f796f7520617265206e6f74206d65000000000000000000000000000000000000600082015250565b6000610667600e83610620565b915061067282610631565b602082019050919050565b600060208201905081810360008301526106968161065a565b9050919050565b6106a68161052c565b82525050565b6106b58161056a565b82525050565b60006040820190506106d0600083018561069d565b6106dd60208301846106ac565b9392505050565b60008115159050919050565b6106f9816106e4565b811461070457600080fd5b50565b600081519050610716816106f0565b92915050565b60006020828403121561073257610731610507565b5b600061074084828501610707565b91505092915050565b610752816106e4565b82525050565b600060408201905061076d6000830185610749565b61077a602083018461069d565b9392505050565b6000819050919050565b6000819050919050565b6000819050919050565b60006107ba6107b56107b084610781565b610795565b61078b565b9050919050565b6107ca8161079f565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561080a5780820151818401526020810190506107ef565b83811115610819576000848401525b50505050565b6000601f19601f8301169050919050565b600061083b826107d0565b61084581856107db565b93506108558185602086016107ec565b61085e8161081f565b840191505092915050565b600060608201905061087e60008301866107c1565b61088b60208301856107c1565b818103604083015261089d8184610830565b9050949350505050565b60006020820190506108bc600083018461069d565b92915050565b6000815190506108d181610574565b92915050565b6000602082840312156108ed576108ec610507565b5b60006108fb848285016108c2565b9150509291505056fea264697066735822122095441d0f2a5b16156494dfb9d799f3a3524ece147caf90c6b875cc338be4e09564736f6c634300080a0033").unwrap();

    let evmole_info = evmole::contract_info(
        evmole::ContractInfoArgs::new(&code)
            .with_selectors()
            .with_arguments()
	    .with_storage()
            .with_state_mutability(),
    );

    //println!("Contract Info: {:?}", evmole_info);

    // Print Functions
    if let Some(funcs) = evmole_info.functions {
        println!("\nFunctions:");
        for function in funcs {
            let selector_hex: String = format!("0x{}", hex::encode(&function.selector));
            let arguments: String = if let Some(args) = &function.arguments {
                args.iter()
                    .map(|arg| format!("{:?}", arg))
                    .collect::<Vec<_>>()
                    .join(", ")
            } else {
                "None".to_string()
            };

            let state_mutability = function.state_mutability
                .as_ref()
                .map(|s| format!("{:?}", s))
                .unwrap_or("None".to_string());

            println!(
                "Function: {{ Selector: {}, Bytecode Offset: {}, Arguments: [{}], State Mutability: {} }}",
                selector_hex, function.bytecode_offset, arguments, state_mutability
            );
        }
    } else {
        println!("No functions found.");
    }

    // Print Storage Information
    if let Some(storage) = evmole_info.storage {
        println!("\nStorage Records:");
        for record in storage {
            let slot_hex = format!("0x{}", hex::encode(&record.slot));
            let reads: String = record
                .reads
                .iter()
                .map(|selector| format!("0x{}", hex::encode(selector)))
                .collect::<Vec<_>>()
                .join(", ");

            let writes: String = record
                .writes
                .iter()
                .map(|selector| format!("0x{}", hex::encode(selector)))
                .collect::<Vec<_>>()
                .join(", ");

            println!(
                "Storage Record: {{ Slot: {}, Offset: {}, Type: {}, Reads: [{}], Writes: [{}] }}",
                slot_hex, record.offset, record.r#type, reads, writes
            );
        }
    } else {
        println!("No storage records found.");
    }
}
